<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramedic Clinical Simulation</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #e74c3c;
            --accent: #27ae60;
            --bg: #f4f7f6;
            --text: #333;
            --white: #ffffff;
            --border: #dcdde1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        header {
            border-bottom: 2px solid var(--primary);
            margin-bottom: 25px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
        }

        #api-settings {
            display: none;
            background: #eee;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        h1 { color: var(--primary); margin: 0; font-size: 1.8rem; }
        h2 { color: var(--primary); font-size: 1.3rem; margin-top: 20px; }

        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
        }

        textarea, input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        button {
            background-color: var(--primary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        button:hover {
            background-color: #1a252f;
        }

        .dispatch-info {
            background: #eef2f3;
            padding: 15px;
            border-left: 5px solid var(--secondary);
            margin-bottom: 20px;
        }

        /* Dialogue Styles */
        #chat-box {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            background: #fafafa;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .message {
            margin-bottom: 12px;
            max-width: 85%;
        }

        .message.user {
            margin-left: auto;
            text-align: right;
        }

        .bubble {
            display: inline-block;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 0.95rem;
        }

        .message.user .bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.bot .bubble {
            background: #eee;
            color: #333;
            border-bottom-left-radius: 2px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }

        .error-msg {
            color: var(--secondary);
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>EMS Sim</h1>
        <button class="settings-btn" onclick="toggleSettings()">⚙️</button>
    </header>

    <!-- API SETTINGS (Required for GitHub Pages) -->
    <div id="api-settings">
        <label>Google Gemini API Key:</label>
        <input type="password" id="api-key-input" placeholder="Paste your API key here">
        <p style="font-size: 0.8rem; margin: 10px 0;">Key is saved locally in your browser. Get one at <a href="https://aistudio.google.com/" target="_blank">Google AI Studio</a>.</p>
        <button onclick="saveApiKey()">Save Settings</button>
    </div>

    <div id="status-bar" class="status-bar" style="display: none;">
        <span id="display-incident">Incident: Cardiac</span>
        <span id="display-location">Location: Residence</span>
    </div>

    <!-- 1. INTRO / GENERATION -->
    <div id="section-intro" class="section active">
        <h2>Generate New Scenario</h2>
        <p>Enter a chief complaint or leave blank for a random medical emergency.</p>
        <div class="input-group">
            <input type="text" id="user-complaint" placeholder="e.g. Chest Pain, Difficulty Breathing...">
        </div>
        <button onclick="generateScenario()">Start Simulation</button>
        <p id="loading-msg" style="display:none; color: var(--secondary); margin-top: 10px;">Generating clinical case...</p>
        <p id="config-error" class="error-msg">Please set your API Key in the ⚙️ settings first!</p>
    </div>

    <!-- 2. DISPATCH -->
    <div id="section-dispatch" class="section">
        <h2>Dispatch Information</h2>
        <div class="dispatch-info">
            <p><strong>Call Details:</strong> <span id="dispatch-details"></span></p>
            <p><strong>Location Type:</strong> <span id="dispatch-loc"></span></p>
        </div>

        <div class="input-group">
            <label>Working Diagnosis (Differential):</label>
            <textarea id="working-diag" rows="3" placeholder="What do you think is happening based on dispatch?"></textarea>
        </div>

        <div class="input-group">
            <label>Equipment to Bring In:</label>
            <textarea id="equip-list" rows="2" placeholder="Lifebox, Monitor, Suction, etc."></textarea>
        </div>

        <button onclick="goToAssessment()">Arrive on Scene</button>
    </div>

    <!-- 3. ASSESSMENT (INTERACTIVE) -->
    <div id="section-assessment" class="section">
        <h2>Patient Assessment</h2>
        <p>Interview the patient or ask about findings. They will respond in character.</p>
        
        <div id="chat-box">
            <div class="message bot">
                <div class="bubble">You have arrived on scene. The patient is visible. What would you like to ask or do?</div>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="chat-input" placeholder="Ask a question..." onkeypress="handleKey(event)">
            <button onclick="sendMessage()">Send</button>
        </div>

        <div style="margin-top: 20px;">
            <button onclick="goToTreatment()">Proceed to Treatment Plan</button>
        </div>
    </div>

    <!-- 4. TREATMENT & HANDOVER -->
    <div id="section-treatment" class="section">
        <h2>Management & Handover</h2>
        <div class="input-group">
            <label>Immediate Treatments/Interventions:</label>
            <textarea id="treatments" rows="4" placeholder="Oxygen, IV, Drugs, Positioning..."></textarea>
        </div>
        <div class="input-group">
            <label>ATMIST Handover (to Hospital):</label>
            <textarea id="handover" rows="6" placeholder="A: Age, T: Time, M: Mechanism, I: Injuries/Illness, S: Signs, T: Treatment"></textarea>
        </div>
        <button onclick="finishSim()">Submit Case for Review</button>
    </div>

    <!-- 5. FEEDBACK -->
    <div id="section-feedback" class="section">
        <h2>Clinical Feedback</h2>
        <div id="feedback-content" style="white-space: pre-wrap; line-height: 1.6; background: #f9f9f9; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
            Analyzing your performance...
        </div>
        <button style="margin-top: 20px;" onclick="location.reload()">Start New Session</button>
    </div>
</div>

<script>
    // Retrieve API key from local storage (critical for GitHub Pages)
    let savedKey = localStorage.getItem('PARAMEDIC_SIM_API_KEY') || "";
    document.getElementById('api-key-input').value = savedKey;

    let currentScenario = null;
    let chatHistory = [];

    function toggleSettings() {
        const panel = document.getElementById('api-settings');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function saveApiKey() {
        const val = document.getElementById('api-key-input').value.trim();
        localStorage.setItem('PARAMEDIC_SIM_API_KEY', val);
        savedKey = val;
        alert("Settings saved!");
        toggleSettings();
    }

    async function callGemini(prompt, systemPrompt = "", isJson = false) {
        if (!savedKey) {
            document.getElementById('config-error').style.display = 'block';
            toggleSettings();
            return null;
        }

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${savedKey}`;
        
        const payload = {
            contents: [{ parts: [{ text: prompt }] }]
        };

        if (systemPrompt) {
            payload.systemInstruction = { parts: [{ text: systemPrompt }] };
        }

        if (isJson) {
            payload.generationConfig = { responseMimeType: "application/json" };
        }

        for (let i = 0; i < 5; i++) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error.message);
                }
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) {
                if (i === 4) alert("API Error: " + e.message);
                await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
            }
        }
        return null;
    }

    async function generateScenario() {
        const complaint = document.getElementById('user-complaint').value;
        document.getElementById('loading-msg').style.display = 'block';
        document.getElementById('config-error').style.display = 'none';

        const prompt = `Generate a detailed paramedic clinical scenario. Chief complaint: ${complaint || 'Random medical emergency'}. 
        Return JSON with these exact keys: 
        "dispatch_summary": "Short 1-sentence dispatch alert",
        "location": "e.g. Public Park, Private Home",
        "patient_details": {
            "age": 45,
            "gender": "male/female",
            "history": "PMH details",
            "medications": "current meds",
            "allergies": "allergies"
        },
        "vitals": { "hr": 0, "bp": "0/0", "rr": 0, "spo2": 0, "temp": 0, "gcs": 15, "glucose": 0 },
        "actual_diagnosis": "Hidden diagnosis",
        "patient_personality": "How they should talk (scared, aggressive, quiet, etc.)"`;

        const result = await callGemini(prompt, "You are a clinical educator. Provide a realistic paramedic scenario in JSON.", true);
        
        if (result) {
            currentScenario = JSON.parse(result);
            document.getElementById('dispatch-details').innerText = currentScenario.dispatch_summary;
            document.getElementById('dispatch-loc').innerText = currentScenario.location;
            
            showSection('dispatch');
            document.getElementById('status-bar').style.display = 'flex';
            document.getElementById('display-incident').innerText = "Complaint: " + (complaint || "Medical");
            document.getElementById('display-location').innerText = "Loc: " + currentScenario.location;
        }
        document.getElementById('loading-msg').style.display = 'none';
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-' + id).classList.add('active');
        window.scrollTo(0, 0);
    }

    function goToAssessment() {
        showSection('assessment');
    }

    function handleKey(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;

        addMessage(text, 'user');
        input.value = '';

        const systemPrompt = `You are a patient in a paramedic simulation. 
        Case: ${currentScenario.actual_diagnosis}. 
        Details: ${JSON.stringify(currentScenario.patient_details)}. 
        Personality: ${currentScenario.patient_personality}.
        Current Vitals if asked: ${JSON.stringify(currentScenario.vitals)}.
        Respond as the patient in first person. Be realistic. Do not give away the diagnosis unless they ask questions that would reveal it. 
        If they ask for vitals or check them, describe how you feel or provide the numbers if they are checking a monitor.`;

        const response = await callGemini(text, systemPrompt);
        if (response) {
            addMessage(response, 'bot');
            chatHistory.push({ q: text, a: response });
        }
    }

    function addMessage(text, type) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = `<div class="bubble">${text}</div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function goToTreatment() {
        showSection('treatment');
    }

    async function finishSim() {
        showSection('feedback');
        const feedbackDiv = document.getElementById('feedback-content');
        
        const studentData = {
            workingDiag: document.getElementById('working-diag').value,
            equipment: document.getElementById('equip-list').value,
            history: chatHistory,
            treatment: document.getElementById('treatments').value,
            handover: document.getElementById('handover').value
        };

        const prompt = `Review this paramedic student's performance. 
        Actual Case: ${currentScenario.actual_diagnosis}.
        Student's Working Diagnosis (at Dispatch): ${studentData.workingDiag}.
        Student's Equipment Choice: ${studentData.equipment}.
        Assessment Interaction: ${JSON.stringify(studentData.history)}.
        Treatment Plan: ${studentData.treatment}.
        Handover (ATMIST): ${studentData.handover}.
        
        Provide:
        1. Accuracy of working diagnosis and equipment choice.
        2. Quality of patient assessment.
        3. Clinical appropriateness of treatment.
        4. Areas for improvement.`;

        const feedback = await callGemini(prompt, "You are an expert Paramedic Mentor. Provide constructive, detailed feedback.");
        feedbackDiv.innerText = feedback || "Error generating feedback. Please try again.";
    }
</script>

</body>
</html>

