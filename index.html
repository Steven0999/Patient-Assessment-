<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramedic Clinical Simulation</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #e74c3c;
            --accent: #27ae60;
            --bg: #f4f7f6;
            --text: #333;
            --white: #ffffff;
            --border: #dcdde1;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 15px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        header {
            border-bottom: 3px solid var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section { display: none; }
        .active { display: block; }

        .phase-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-left: 4px solid var(--primary);
            margin: 20px 0;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f1f2f6;
            width: 30%;
        }

        .mandatory-box {
            background: #fff5f5;
            border: 2px solid var(--secondary);
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        textarea, input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover { background: #1a252f; }

        /* Chat Styles */
        #chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            background: #fafafa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; line-height: 1.4; }
        .user-msg { background: var(--primary); color: white; margin-left: auto; }
        .bot-msg { background: #eee; color: #333; }

        .loading { color: var(--secondary); font-style: italic; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2 id="app-title">Paramedic Training Sim</h2>
        <div id="loading-indicator" class="loading" style="display:none;">Communicating with Clinical Lead...</div>
    </header>

    <!-- STEP 0: GENERATION -->
    <div id="step-0" class="section active">
        <h3>Start New Simulation</h3>
        <p>Enter a chief complaint (e.g., "Difficulty breathing") or leave blank for a random case.</p>
        <input type="text" id="user-input-complaint" placeholder="Complaint...">
        <br><br>
        <button onclick="initScenario()">Initialize Case</button>
    </div>

    <!-- PHASE 1: DISPATCH -->
    <div id="step-1" class="section">
        <div class="phase-header">1. Dispatch Phase (Initial Call & Planning)</div>
        <table>
            <tr><th>Location</th><td id="d-loc"></td></tr>
            <tr><th>Age/Sex</th><td id="d-age-sex"></td></tr>
            <tr><th>Presenting Complaint</th><td id="d-complaint"></td></tr>
            <tr><th>Initial Safety Concerns</th><td><input type="text" id="p1-safety" placeholder="e.g., Traffic, Bystanders..."></td></tr>
        </table>

        <div class="mandatory-box">
            <strong>What to Bring In (MANDATORY Single List)</strong>
            <p><small>List the single, most critical set of equipment, drugs, and tools required immediately.</small></p>
            <textarea id="p1-equipment" rows="4" placeholder="1. Lifepak 15&#10;2. Response Bag&#10;3. Suction..."></textarea>
        </div>
        <button onclick="showStep(2)">Arrive on Scene</button>
    </div>

    <!-- PHASE 2: ASSESSMENT -->
    <div id="step-2" class="section">
        <div class="phase-header">2. Assessment Phase (On Scene & Diagnosis)</div>
        
        <div id="chat-container">
            <div class="msg bot-msg">You have arrived. The patient is visible. You can now begin your assessment by asking questions.</div>
        </div>
        <div style="display:flex; gap: 10px; margin-bottom: 20px;">
            <input type="text" id="chat-input" placeholder="Ask the patient something..." onkeydown="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()">Ask</button>
        </div>

        <table>
            <tr><th>Primary Survey (ABCDE)</th><td><textarea id="p2-abcde"></textarea></td></tr>
            <tr><th>Secondary Survey (SAMPLE)</th><td><textarea id="p2-sample"></textarea></td></tr>
            <tr><th>Vitals</th><td><textarea id="p2-vitals" placeholder="HR, BP, Sats, Temp, GCS, BGL"></textarea></td></tr>
        </table>

        <div class="mandatory-box">
            <strong>Working Diagnosis (MANDATORY Single Box)</strong>
            <textarea id="p2-diagnosis" rows="2" placeholder="e.g., Acute Pulmonary Edema secondary to AF."></textarea>
        </div>
        <button onclick="showStep(3)">Proceed to Action Phase</button>
    </div>

    <!-- PHASE 3: ACTION -->
    <div id="step-3" class="section">
        <div class="phase-header">3. Action Phase (Treatment & Transport)</div>
        <table>
            <tr><th>Treatment Plan</th><td><textarea id="p3-plan"></textarea></td></tr>
            <tr><th>Drug Administration</th><td><textarea id="p3-drugs" placeholder="Drug, Dose, Route"></textarea></td></tr>
            <tr><th>Transport Decision</th><td><textarea id="p3-transport" placeholder="Category, Destination"></textarea></td></tr>
            <tr><th>Handover Summary</th><td><textarea id="p3-handover" rows="4"></textarea></td></tr>
        </table>
        <button onclick="getFeedback()">Complete Simulation & Get Feedback</button>
    </div>

    <!-- FEEDBACK -->
    <div id="step-4" class="section">
        <div class="phase-header">Clinical Performance Review</div>
        <div id="feedback-text" style="white-space: pre-wrap; line-height: 1.6; padding: 15px; border: 1px solid #ddd;"></div>
        <br>
        <button onclick="location.reload()">New Case</button>
    </div>
</div>

<script>
    const apiKey = ""; // Runtime key
    let scenario = null;

    async function callGemini(prompt, system, json = false) {
        document.getElementById('loading-indicator').style.display = 'block';
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: system }] }
        };
        if (json) payload.generationConfig = { responseMimeType: "application/json" };

        try {
            const response = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (e) {
            console.error(e);
            return null;
        } finally {
            document.getElementById('loading-indicator').style.display = 'none';
        }
    }

    async function initScenario() {
        const complaint = document.getElementById('user-input-complaint').value;
        const system = "Generate a paramedic clinical case. Return JSON: {dispatch_loc, age, sex, complaint, actual_diagnosis, vitals_obj, findings_abcde, history_sample, patient_personality}";
        const prompt = `Create a case for: ${complaint || 'random medical emergency'}. 
        vitals_obj should contain numbers for HR, BP, RR, SpO2, Temp, GCS, BGL. 
        patient_personality describes how they speak.`;
        
        const raw = await callGemini(prompt, system, true);
        if (raw) {
            scenario = JSON.parse(raw);
            document.getElementById('d-loc').innerText = scenario.dispatch_loc;
            document.getElementById('d-age-sex').innerText = `${scenario.age} / ${scenario.sex}`;
            document.getElementById('d-complaint').innerText = scenario.complaint;
            showStep(1);
        }
    }

    async function sendChat() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text || !scenario) return;

        addChat(text, 'user-msg');
        input.value = '';

        const system = `You are a patient in a paramedic simulation. 
        Diagnosis: ${scenario.actual_diagnosis}. 
        Personality: ${scenario.patient_personality}. 
        Details: ${JSON.stringify(scenario.history_sample)}. 
        Findings: ${JSON.stringify(scenario.findings_abcde)}.
        If the student asks for vitals, give them the values: ${JSON.stringify(scenario.vitals_obj)}.
        Stay in character. Short, realistic responses.`;

        const reply = await callGemini(text, system);
        if (reply) addChat(reply, 'bot-msg');
    }

    function addChat(text, className) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `msg ${className}`;
        div.innerText = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function showStep(n) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${n}`).classList.add('active');
        window.scrollTo(0,0);
    }

    async function getFeedback() {
        showStep(4);
        const report = {
            safety: document.getElementById('p1-safety').value,
            equipment: document.getElementById('p1-equipment').value,
            diag: document.getElementById('p2-diagnosis').value,
            treatment: document.getElementById('p3-plan').value,
            handover: document.getElementById('p3-handover').value
        };

        const prompt = `Compare the student's actions to the gold standard for this case: ${scenario.actual_diagnosis}.
        Student Report: ${JSON.stringify(report)}.
        Provide a clinical critique based on the three phases: Dispatch, Assessment, and Action.`;
        
        const feedback = await callGemini(prompt, "You are a senior Paramedic Educator.");
        document.getElementById('feedback-text').innerText = feedback || "Feedback unavailable.";
    }
</script>

</body>
</html>

