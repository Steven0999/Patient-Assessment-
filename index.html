<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECAmb MDT - Clinical Simulation</title>
    <style>
        :root {
            --primary: #005eb8;
            --accent: #007f3b;
            --warning: #ffb81c;
            --danger: #d63031;
            --bg: #0b0b0b;
            --card-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            --border: #333;
            --trauma-purple: #6c5ce7;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; overflow-x: hidden; }
        .container { width: 100%; max-width: 600px; min-height: 100vh; margin: auto; display: flex; flex-direction: column; border-left: 1px solid var(--border); border-right: 1px solid var(--border); box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        header { background: #000; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); position: sticky; top: 0; z-index: 50; }
        .unit-id { font-weight: 900; color: var(--warning); font-size: 1.3rem; letter-spacing: 1px; }
        
        .section { display: none; padding: 15px; flex-grow: 1; animation: fadeIn 0.3s ease; }
        .section.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* API & Start Styling */
        .start-card { text-align: center; padding: 30px 10px; }
        .api-input-group { background: #222; padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; text-align: left; }
        
        /* CAD Styling */
        .cad-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .cad-item { background: var(--card-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
        .label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; margin-bottom: 4px; display: block; }
        .value { font-size: 1.1rem; font-weight: 700; color: #fff; }
        .badge { padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 800; }
        .cat-1 { background: var(--danger); }
        .cat-trauma { background: var(--trauma-purple); }

        /* Patient Interaction Styling */
        .vitals-bar { background: #000; padding: 10px; border-radius: 8px; display: flex; justify-content: space-around; font-family: 'Courier New', monospace; border: 1px solid #444; margin-bottom: 15px; color: #00ff00; text-shadow: 0 0 5px #00ff00; }
        .vital-item { text-align: center; }
        .vital-val { font-size: 1.1rem; display: block; }
        .vital-lbl { font-size: 0.6rem; color: #00aa00; text-transform: uppercase; }

        #chat-window { flex-grow: 1; background: #050505; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; height: 400px; }
        .msg { padding: 12px 16px; border-radius: 15px; max-width: 85%; line-height: 1.5; font-size: 0.95rem; }
        .msg-user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-pt { align-self: flex-start; background: #262626; color: #fff; border-bottom-left-radius: 2px; border-left: 4px solid var(--warning); }
        .msg-sys { align-self: center; background: transparent; color: var(--text-muted); font-size: 0.8rem; text-align: center; font-style: italic; }

        /* General UI */
        button { padding: 15px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-green { background: var(--accent); color: white; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-purple { background: var(--trauma-purple); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: white; }
        
        input, select, textarea { background: #1a1a1a; border: 1px solid var(--border); color: white; padding: 14px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 1rem; }
        input:focus { border-color: var(--primary); outline: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="unit-id">SEC-K232</div>
        <div id="clock" style="font-family: monospace; font-size: 1.1rem; color: var(--warning);">00:00:00</div>
    </header>

    <!-- 1. API KEY & START -->
    <div id="sec-start" class="section active">
        <div class="start-card">
            <h1 style="margin-bottom: 5px;">SECAmb MDT</h1>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Professional Clinical Simulation</p>

            <div class="api-input-group">
                <label class="label">Gemini API Key</label>
                <input type="password" id="api-key" placeholder="Enter API Key to begin..." style="letter-spacing: 2px;">
                <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;">Your key powers the AI patient and clinical audit.</p>
            </div>

            <div style="text-align: left; margin-bottom: 20px;">
                <label class="label">Response Capability</label>
                <select id="role-select" onchange="syncSubtypes()">
                    <option value="standard">Standard Ambulance (DCA)</option>
                    <option value="trauma">Critical Care (CCP/HEMS)</option>
                    <option value="incident">HART / Incident Response</option>
                </select>
            </div>

            <div style="text-align: left; margin-bottom: 30px;">
                <label class="label">Simulation Focus</label>
                <select id="subtype-select"></select>
            </div>

            <button id="btn-ready" class="btn-green" style="width: 100%;" onclick="initializeSimulation()">GO AVAILABLE</button>
            <p id="start-status" style="margin-top: 15px; font-size: 0.85rem; color: var(--warning);"></p>
        </div>
    </div>

    <!-- 2. DISPATCH -->
    <div id="sec-dispatch" class="section">
        <div class="cad-grid">
            <div class="cad-item"><span class="label">URN</span><div class="value" id="cad-urn">---</div></div>
            <div class="cad-item"><span class="label">Code</span><div class="value" id="cad-code">---</div></div>
            <div class="cad-item" style="grid-column: span 2;"><span class="label">Location</span><div class="value" id="cad-loc">---</div></div>
            <div class="cad-item"><span class="label">Priority</span><div id="cad-cat" class="badge">---</div></div>
            <div class="cad-item"><span class="label">Focus</span><div class="value" id="cad-focus">---</div></div>
        </div>
        <div class="cad-item" style="border-left: 4px solid var(--primary); margin-bottom: 20px;">
            <span class="label">Dispatch Notes</span>
            <div id="cad-notes" style="font-size: 0.9rem; line-height: 1.4;">---</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn-blue" onclick="setStatus('MOBILE')">MOBILE</button>
            <button class="btn-green" onclick="setStatus('AT SCENE')">AT SCENE</button>
        </div>
    </div>

    <!-- 3. PATIENT INTERACTION -->
    <div id="sec-interaction" class="section">
        <div class="vitals-bar">
            <div class="vital-item"><span class="vital-lbl">HR</span><span class="vital-val" id="v-hr">--</span></div>
            <div class="vital-item"><span class="vital-lbl">BP</span><span class="vital-val" id="v-bp">--/--</span></div>
            <div class="vital-item"><span class="vital-lbl">RR</span><span class="vital-val" id="v-rr">--</span></div>
            <div class="vital-item"><span class="vital-lbl">SpO2</span><span class="vital-val" id="v-spo2">--%</span></div>
            <div class="vital-item"><span class="vital-lbl">GCS</span><span class="vital-val" id="v-gcs">--</span></div>
        </div>

        <div id="chat-window"></div>

        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <input type="text" id="chat-input" placeholder="Speak or assess..." onkeypress="if(event.key==='Enter') sendAction()">
            <button class="btn-blue" style="padding: 0 25px;" onclick="sendAction()">SEND</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <button class="btn-outline" style="font-size: 0.7rem;" onclick="quickAction('Check Vitals')">VITALS</button>
            <button class="btn-outline" style="font-size: 0.7rem;" onclick="quickAction('Primary Survey')">SURVEY</button>
            <button class="btn-outline" style="font-size: 0.7rem;" onclick="quickAction('Physical Exam')">EXAMINE</button>
        </div>
        <button class="btn-green" style="width: 100%;" onclick="showSection('handover')">HANDOVER / CLEAR</button>
    </div>

    <!-- 4. HANDOVER -->
    <div id="sec-handover" class="section">
        <h3 style="margin-top:0">Clinical Handover (ATMIST)</h3>
        <textarea id="atmist-input" style="height: 300px; font-family: monospace; font-size: 0.9rem;" placeholder="A: Age / Gender
T: Time
M: Mechanism
I: Injuries / Illness
S: Signs (Vitals)
T: Treatment"></textarea>
        <button id="btn-audit" class="btn-green" style="margin-top: 15px;" onclick="requestAudit()">FINALISE & AUDIT</button>
    </div>

    <!-- 5. AUDIT -->
    <div id="sec-audit" class="section">
        <h3>Clinical Governance Review</h3>
        <div id="audit-content" style="background:#1a1a1a; padding:20px; border-radius:12px; font-size: 0.95rem; line-height: 1.6; border: 1px solid var(--border); overflow-y: auto;"></div>
        <button class="btn-blue" style="margin-top: 20px;" onclick="location.reload()">CLEAR UNIT & LOG OFF</button>
    </div>
</div>

<script>
    const subTypes = {
        standard: ["Airway", "Breathing", "Circulation", "Disability", "Environment", "Social", "Mental Health"],
        trauma: ["TCA (Traumatic Cardiac Arrest)", "Major Trauma", "Catastrophic Hemorrhage", "Head Injury", "Multi-System Trauma"],
        incident: ["HAZMAT", "CBRN", "MTA (Marauding Terrorist Attack)", "Confined Space", "Water Rescue Support", "Major Incident Triage"]
    };

    let userKey = "";
    let currentJob = null;

    function syncSubtypes() {
        const role = document.getElementById('role-select').value;
        const sub = document.getElementById('subtype-select');
        sub.innerHTML = "";
        subTypes[role].forEach(t => {
            const opt = document.createElement('option');
            opt.value = t; opt.innerText = t;
            sub.appendChild(opt);
        });
    }

    // Clock
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB');
    }, 1000);

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-' + id).classList.add('active');
    }

    function addMessage(type, text) {
        const win = document.getElementById('chat-window');
        const div = document.createElement('div');
        div.className = `msg msg-${type}`;
        div.innerHTML = type === 'pt' ? `<strong>PT:</strong> ${text}` : text;
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    function updateVitals(vString) {
        const hr = vString.match(/HR:?\s?(\d+)/i)?.[1] || "--";
        const bp = vString.match(/BP:?\s?(\d+\/\d+)/i)?.[1] || "--/--";
        const rr = vString.match(/RR:?\s?(\d+)/i)?.[1] || "--";
        const spo2 = vString.match(/SpO2:?\s?(\d+)/i)?.[1] || "--";
        const gcs = vString.match(/GCS:?\s?(\d+)/i)?.[1] || "--";

        document.getElementById('v-hr').innerText = hr;
        document.getElementById('v-bp').innerText = bp;
        document.getElementById('v-rr').innerText = rr;
        document.getElementById('v-spo2').innerText = spo2;
        document.getElementById('v-gcs').innerText = gcs;
    }

    async function callGemini(prompt, system, isJson = false) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: system }] }
        };
        if (isJson) payload.generationConfig = { responseMimeType: "application/json" };
        
        try {
            const resp = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const data = await resp.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        } catch (e) {
            console.error(e);
            return isJson ? "{}" : "Error: " + e.message;
        }
    }

    async function initializeSimulation() {
        userKey = document.getElementById('api-key').value.trim();
        if (!userKey) {
            alert("Please enter a valid Gemini API Key.");
            return;
        }

        const status = document.getElementById('start-status');
        const btn = document.getElementById('btn-ready');
        const role = document.getElementById('role-select').value;
        const focus = document.getElementById('subtype-select').value;

        btn.disabled = true;
        status.innerText = "POLLING DISPATCH...";

        const system = `You are a SECAmb Dispatcher. Role: ${role}. Focus: ${focus}. 
        Return JSON: {urn, code, cat, loc, type, notes, hidden_data: { diagnosis, vitals, persona } }`;

        const res = await callGemini(`Generate ${focus} emergency.`, system, true);
        try {
            currentJob = JSON.parse(res);
            document.getElementById('cad-urn').innerText = currentJob.urn || "URN-992";
            document.getElementById('cad-code').innerText = currentJob.code || "10-D-1";
            document.getElementById('cad-loc').innerText = currentJob.loc || "Local Vicinity";
            document.getElementById('cad-focus').innerText = focus;
            document.getElementById('cad-notes').innerText = currentJob.notes;
            
            const cat = document.getElementById('cad-cat');
            cat.innerText = "CAT " + (currentJob.cat || 1);
            cat.className = "badge cat-" + (role === 'trauma' ? 'trauma' : (currentJob.cat || 1));

            showSection('dispatch');
        } catch (e) {
            status.innerText = "Connection Error. Try again.";
            btn.disabled = false;
        }
    }

    function setStatus(s) {
        if (s === 'AT SCENE') {
            showSection('interaction');
            addMessage('sys', "You have arrived. The patient is in front of you.");
            updateVitals(currentJob.hidden_data.vitals);
            // Initial patient engagement
            sendAction("Hello, I'm from the ambulance service. Can you hear me?", true);
        }
    }

    async function sendAction(manualText = null, auto = false) {
        const input = document.getElementById('chat-input');
        const text = manualText || input.value.trim();
        if (!text) return;

        if (!auto) addMessage('user', text);
        input.value = "";

        const system = `You are the patient. Persona: ${currentJob.hidden_data.persona}. 
        Diagnosis: ${currentJob.hidden_data.diagnosis}. Current Vitals: ${currentJob.hidden_data.vitals}. 
        Respond briefly (1-2 sentences). If the user checks vitals or performs an exam, describe what they find physically.`;

        const resp = await callGemini(text, system);
        addMessage('pt', resp);
    }

    function quickAction(act) {
        addMessage('sys', `Action: ${act}`);
        sendAction(`I am performing a ${act}. What do I find?`, true);
    }

    async function requestAudit() {
        const handover = document.getElementById('atmist-input').value;
        const btn = document.getElementById('btn-audit');
        btn.disabled = true;
        btn.innerText = "AUDITING...";

        showSection('audit');
        document.getElementById('audit-content').innerHTML = "<em>Analyzing clinical performance against JRCALC guidelines...</em>";

        const system = `Audit this SECAmb simulation. 
        Patient Diagnosis: ${currentJob.hidden_data.diagnosis}. 
        Focus: ${document.getElementById('cad-focus').innerText}. 
        Handover Given: ${handover}. 
        Provide a professional clinical critique, highlighting strengths and missing steps. Use Markdown.`;

        const audit = await callGemini("Perform Audit", system);
        document.getElementById('audit-content').innerHTML = audit;
    }

    window.onload = syncSubtypes;
</script>

</body>
</html>


